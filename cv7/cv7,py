import sys
import os

# Přidá parent directory (kde je base složka) do Python path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import numpy as np
import random
import math
import base.visualization as visualization

def calculate_distance_matrix(cities):
    n = len(cities)
    distances = np.zeros((n, n))
    
    for i in range(n):
        for j in range(i + 1, n):
            # Euklidovská vzdálenost
            dist = math.sqrt((cities[i][0] - cities[j][0])**2 + 
                           (cities[i][1] - cities[j][1])**2)
            distances[i][j] = dist
            distances[j][i] = dist
    
    return distances


def ant_colony_tsp(
    cities,
    n_ants=20,
    n_iterations=100,
    alpha=1.0,
    beta=2.0,
    evaporation_rate=0.5,
    q=100.0
):
    distances = calculate_distance_matrix(cities)
    n_cities = len(distances)
    
    # Inicializace feromonové matice
    pheromones = np.ones((n_cities, n_cities))
    
    # Nejlepší řešení
    best_path = None
    best_distance = float('inf')
    
    for iteration in range(n_iterations):
        # Cesty všech mravenců v této iteraci
        all_paths = []
        all_distances = []
        
        for ant in range(n_ants):
            # Vytvoření cesty pro mravence
            path = construct_path(n_cities, distances, pheromones, alpha, beta)
            distance = calculate_path_distance(path, distances)
            
            all_paths.append(path)
            all_distances.append(distance)
            
            # Aktualizace nejlepšího řešení
            if distance < best_distance:
                best_distance = distance
                best_path = path.copy()
        
        # Vypařování feromonu
        pheromones *= (1 - evaporation_rate)
        
        # Přidání nového feromonu
        for path, distance in zip(all_paths, all_distances):
            pheromone_deposit = q / distance
            for i in range(len(path) - 1):
                city_a = path[i]
                city_b = path[i + 1]
                pheromones[city_a][city_b] += pheromone_deposit
                pheromones[city_b][city_a] += pheromone_deposit
            
            # Spojení poslední a první město
            pheromones[path[-1]][path[0]] += pheromone_deposit
            pheromones[path[0]][path[-1]] += pheromone_deposit
    
    return best_path, best_distance


def construct_path(n_cities, distances, pheromones, alpha, beta):
    # Začni v náhodném městě
    current_city = random.randint(0, n_cities - 1)
    path = [current_city]
    unvisited = set(range(n_cities))
    unvisited.remove(current_city)
    
    while unvisited:
        # Výpočet pravděpodobností pro všechna nenavštívená města
        probabilities = []
        cities = list(unvisited)
        
        for city in cities:
            # Feromon^alpha * (1/vzdálenost)^beta
            pheromone = pheromones[current_city][city] ** alpha
            heuristic = (1.0 / distances[current_city][city]) ** beta if distances[current_city][city] > 0 else 0
            probabilities.append(pheromone * heuristic)
        
        # Normalizace pravděpodobností
        total = sum(probabilities)
        if total == 0:
            # Pokud jsou všechny pravděpodobnosti 0, vyber náhodně
            next_city = random.choice(cities)
        else:
            probabilities = [p / total for p in probabilities]
            # Výběr dalšího města podle pravděpodobnosti
            next_city = random.choices(cities, weights=probabilities)[0]
        
        path.append(next_city)
        unvisited.remove(next_city)
        current_city = next_city
    
    return path


def calculate_path_distance(path, distances):
    total_distance = 0
    for i in range(len(path) - 1):
        total_distance += distances[path[i]][path[i + 1]]
    # Přidej vzdálenost zpět na začátek
    total_distance += distances[path[-1]][path[0]]
    return total_distance


# Příklad použití
if __name__ == "__main__":
    random.seed(42)
    cities = [(random.randint(0, 200), random.randint(0, 200)) for _ in range(15)]
        
    best_path, best_distance = ant_colony_tsp(
        cities=cities,
        n_ants=30,
        n_iterations=100,
        alpha=1.0,
        beta=2.0,
        evaporation_rate=0.5,
        q=100.0
    )
    
    visualization.animate_tsp_best_route(cities, best_path)